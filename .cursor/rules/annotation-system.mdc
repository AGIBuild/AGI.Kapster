---
description: Annotation system architecture and patterns
globs: **/Overlays/*.cs,**/Services/Annotation/*.cs,**/Commands/*.cs
---

# Annotation System

## Components
- **NewAnnotationOverlay** - Drawing canvas with pointer event handling
- **NewAnnotationToolbar** - Tool selection UI
- **AnnotationService** - Annotation state management
- **Command Pattern** - Undo/redo support

## Drawing Lifecycle
1. Tool selection (toolbar or hotkey: A/R/E/T/F/M)
2. Pointer press → start annotation
3. Pointer move → update geometry
4. Pointer release → finalize
5. Selection mode (S key) → edit existing annotations

## Key Patterns
**Cursor Management**: Force cross cursor when tool is active
```csharp
if (CurrentTool != AnnotationToolType.None)
    Cursor = new Cursor(StandardCursorType.Cross);
```

**Direct References**: Use stored field references, not FindControl<>()

**Commands**: Each annotation operation is an ICommand for undo/redo

## Coordinate Systems
- Screen coordinates for overlay positioning
- Local coordinates for annotation geometry
- Handle DPI scaling appropriately