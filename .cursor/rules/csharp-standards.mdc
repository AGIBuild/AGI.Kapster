---
globs: *.cs
description: C# coding standards and patterns for AGI.Kapster
---

# C# Coding Standards for AGI.Kapster

## Naming Conventions
- **PascalCase**: Classes, methods, properties, enums, public fields
- **camelCase**: Local variables, parameters, private fields (without underscore)
- **_camelCase**: Private fields with underscore prefix
- **UPPER_CASE**: Constants

## Service Lifecycle Patterns
- **ISettingsService**: Singleton pattern via DI container
- Must use dependency injection - no direct instantiation
- Settings loaded in constructor with 3-tier approach
- Changes visible immediately across all consumers

## Error Handling
- Use structured logging with Serilog
- Log levels: Debug, Information (avoid), Warning, Error
- Prefer `Log.Debug()` over `Log.Information()` for development logs
- Always include context in log messages
- Gracefully handle permission errors without throwing

## Async Patterns
- Use `async/await` for I/O operations
- Use `ConfigureAwait(false)` in library code
- Prefer `Task.Run()` for CPU-bound work
- Use `TaskCompletionSource` for event-driven async operations

## MVVM Patterns
- Use CommunityToolkit.Mvvm attributes: `[ObservableProperty]`, `[RelayCommand]`
- ViewModels should not reference UI controls directly
- Use weak event patterns for loosely coupled communication
- Implement `INotifyPropertyChanged` through base classes

## Dependency Injection
- Register services in [Program.cs](mdc:src/AGI.Kapster.Desktop/Program.cs)
- Use appropriate lifetimes: Singleton for shared state, Transient for per-use
- Prefer constructor injection over service locator pattern
- Use interfaces for testability and abstraction

## File I/O Patterns
- Use FileShare.ReadWrite for read operations
- Use FileShare.Read for write operations
- Implement retry logic for sharing violations
- Handle UnauthorizedAccessException gracefully

## Platform-Specific Code
- Use conditional compilation: `#if WINDOWS`, `#if MACOS`
- Check runtime: `RuntimeInformation.IsOSPlatform(OSPlatform.Windows)`
- Implement platform-specific services behind interfaces
- Keep platform code isolated in Services/ directories
